# 요소 병렬 처리
<br/>

**`요소 병렬 처리(Parallel Operation)`** 란 **멀티 코어 CPU 환경에서 전체 요소를 분할해서 각각의 코어가 병렬적으로 처리하는 것**을 말한다.
요소 병렬 처리의 목적은 작업 처리 시간을 줄이기 위한 것에 있다. 자바는 요소 병렬 처리를 위해 **`병렬 스트림`** 을 제공한다.

<br/>

## 동시성과 병렬성
멀티 스레드는 동시성(Concurrency) 또는 병렬성(Parallelism)으로 실행되기 때문에 이들 용어에 대해 정확히 이해하는 것이 좋다.
**`동시성`** 은 멀티 작업을 위해 멀티 스레드가 **하나의 코어**에서 번갈아 가며 실행하는 것을 말하고,
**`병렬성`** 은 멀티 작업을 위해 **멀티 코어**를 각각 이용해서 병렬로 실행하는 것을 말한다.

<img src="https://github.com/silxbro/java/assets/142463332/7ed6ed23-77a1-421c-a1a4-50527a0abb22" width="400" height="220"/><br/>

동시성은 한 시점에 **하나의 작업만** 실행한다. 번갈아 작업을 실행하는 것이 워낙 빠르다보니 동시에 처리되는 것처럼 보일 뿐이다.
병렬성은 한 시점에 **여러 개**의 작업을 **병렬로 실행**하기 때문에 동시성보다는 좋은 성능을 낸다.

병렬성은 **`데이터 병렬성(Data Parallelism)`** 과 **`작업 병렬성(Task Parallelism)`** 으로 구분할 수 있다.

#### [데이터 병렬성]
- 데이터 병렬성은 전체 데이터를 분할해서 서브 데이터셋으로 만들고 이 서브 데이터셋들을 병렬 처리해서 작업을 빨리 끝내는 것을 말한다.
  **자바 병렬 스트림은 데이터 병렬성을 구현한 것**이다.
#### [작업 병렬성]
- 작업 병렬성은 서로 다른 작업을 병렬 처리하는 것을 말한다. 작업 병렬성의 대표적인 예는 **서버 프로그램**이다.
  서버는 각각의 클라이언트에서 요청한 내용을 개별 스레드에서 병렬로 처리한다.

<br/>

## 포크조인 프레임워크
자바 병렬 스트림은 요소들을 병렬 처리하기 위해 **`포크조인 프레임워크(ForkJoin Framework)`** 를 사용한다.
포크조인 프레임워크는 **포크 단계**에서 전체 요소들을 서브 요소셋으로 `분할`하고, 각각의 서브 요소셋을 멀티 코어에서 병렬로 `처리`한다.
**조인 단계**에서는 서브 결과를 `결합`해서 최종 결과를 만들어낸다.

예를 들어 쿼드 코어 CPU에서 병렬 스트림으로 요소들을 처리할 경우 먼저 포크 단계에서 스트림의 전체 요소들을 4개의 서브 요소셋으로 분할한다.
그리고 각각의 서브 요소셋을 개별 코어에서 처리하고, 조인 단계에서는 3번의 결합 과정을 거쳐 최종 결과를 산출한다.

<img src="https://github.com/silxbro/java/assets/142463332/76256959-cd68-4552-84f1-c742e3eded55" width="500" height="300"/><br/>

병렬 처리 스트림은 포크 단계에서 요소를 **순서대로 분할하지 않는다**. 이해하기 쉽도록 위 그림에서는 앞에서부터 차례대로 4등분 했지만,
내부적으로 요소들을 나누는 알고리즘이 있기 때문에 개발자는 신경 쓸 필요가 없다.

포크조인 프레임워크는 병렬 처리를 위해 스레드풀을 사용한다. 각각의 코어에서 서브 요소넷을 처리하는 것은 작업 스레드가 해야 하므로 스레드 관리가 필요하다.
포크조인 프레임워크는 **ExcecutorService의 구현 객체인 `ForkJoinPool`을 사용해서 작업 스레드를 관리**한다.

<img src="https://github.com/silxbro/java/assets/142463332/c1c8c062-076a-43d0-bd02-717f2ccb75eb" width="450" height="350"/><br/>

<br/>

## 병렬 스트림 사용
**자바 병렬 스트림을 이용할 경우에는 백그라운드에서 포크조인 프레임워크가 사용**되기 때문에 개발자는 매우 쉽게 병렬 처리를 할 수 있다.
병렬 스트림은 다음 두 가지 메소드로 얻을 수 있다.

|리턴 타입|메소드|제공 컬렉션 또는 스트림|
|:---|:---|:---|
|`Stream`|**parallelStream**()|List 또는 Set 컬렉션|
|`Stream`<br/>`IntStream`<br/>`LongStream`<br/>`DoubleStream`|**parallel**()|java.util.Stream<br/>java.util.IntStream<br/>java.util.LongStream<br/>java.util.DoubleStream|

**`parallelStream()` 메소드**는 **컬렉션**(List, Set)으로부터 병렬 스트림을 바로 리턴한다. **`parallel()` 메소드**는 **기존 스트림**을 병렬 스트림으로 변환한다.

<br/>

다음 예제는 1억 개의 점수에 대한 평균을 얻을 때 일반 스트림과 병렬 스트림의 처리 시간을 측정한 것이다.
실행 시간을 보면 병렬 스트림에서 요소 처리 시간이 더 빠른 것을 볼 수 있다.
- [ParallelExample.java](https://github.com/silxbro/java/blob/main/src/thisisjava/ch17/sec13/ParallelExample.java)

<br/>

## 병렬 처리 기능
스트림 병렬 처리가 스트림 순차 처리보다 항상 실행 성능이 좋다고 판단해서는 안 된다. 그 전에 먼저 병렬 처리에 영향을 미치는 다음 3가지 요인을 잘 살펴보아야 한다.

#### [요소의 수와 요소당 처리 시간]
컬렉션에 전체 요소의 수가 적고 요소당 처리 시간이 짧으면 일반 스트림이 병렬 스트림보다 빠를 수 있다.
병렬 처리는 포크 및 조인 단계가 있고, 스레드 풀을 생성하는 추가적인 비용이 발생하기 때문이다.

#### [스트림 소스의 종류]
ArrayList와 배열은 인덱스로 요소를 관리하기 때문에 포크 단계에서 요소를 쉽게 분리할 수 있어 병렬 처리 시간이 절약된다.
반면에 HashSet, TreeSet은 요소 분리가 쉽지 않고, LinkedList 역시 링크를 따라가야 하므로 요소 분리가 쉽지 않다. 따라서 이 소스들은 상대적으로 병렬 처리가 늦다.

#### [코어(Core)의 수]
CPU 코어의 수가 많으면 많을수록 병렬 스트림의 성능은 좋아진다. 하지만 코어의 수가 적을 경우에는 일반 스트림이 더 빠를 수 있다.
병렬 스트림은 스레드 수가 증가하여 동시성이 많이 일어나므로 오히려 느려진다.
